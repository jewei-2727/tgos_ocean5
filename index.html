<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; style-src * 'unsafe-inline';">
    
    <title>å®œè˜­æ¼æ¸¯æ°´è³ªç›£æ¸¬ç³»çµ±</title>
    
    <script type="text/javascript" src="https://api.tgos.tw/TGOS_API/tgos?ver=2&AppID=x+JLVSx85Lk=&APIKey=in8W74q0ogpcfW/STwicK8D5QwCdddJf05/7nb+OtDh8R99YN3T0LurV4xato3TpL/fOfylvJ9Wv/khZEsXEWxsBmg+GEj4AuokiNXCh14Rei21U5GtJpIkO++Mq3AguFK/ISDEWn4hMzqgrkxNe1Q==" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; background: #f8f9fa; }
        #MapDiv { position: absolute; top: 0; left: 0; width: calc(100% - 520px); height: 100vh; border-right: 2px solid #333; }
        #controlPanel { position: absolute; top: 0; right: 0; width: 520px; height: 100vh; background: #fff; padding: 20px; box-sizing: border-box; overflow-y: auto; z-index: 1000; }
        .row { margin-bottom: 15px; }
        h2 { color: #2c3e50; border-left: 5px solid #3498db; padding-left: 10px; }
        select { padding: 8px; width: 220px; }
        button { padding: 8px 15px; cursor: pointer; background: #3498db; color: white; border: none; border-radius: 4px; }
        #currentPort { font-weight: bold; color: #e74c3c; font-size: 1.2em; }
        canvas { background: #fff; border: 1px solid #eee; margin-top: 10px; }
    </style>
</head>
<body onload="InitAll();">

<div id="MapDiv"></div>

<div id="controlPanel">
    <h2>å®œè˜­æ¼æ¸¯æ°´è³ªç›£æ¸¬</h2>
    <div class="row">
        <button onclick="InitAll()">ğŸ”„ é‡æ–°æ•´ç†è³‡æ–™</button>
    </div>
    <div class="row">
        <label for="portSelect"><b>é¸æ“‡æ¼æ¸¯ï¼š</b></label>
        <select id="portSelect" onchange="onPortChange()">
            <option value="">-- è«‹é¸æ“‡æ¼æ¸¯ --</option>
        </select>
    </div>
    <div style="background:#ecf0f1; padding:10px; border-radius:5px;">
        ç›®å‰æª¢è¦–ï¼š<span id="currentPort">æœªé¸å–</span>
    </div>
    <hr>
    <h4>pH å€¼è¶¨å‹¢</h4>
    <canvas id="phChart" width="480" height="240"></canvas>
    <h4>æº¶æ°§é‡ (DO) è¶¨å‹¢ (mg/L)</h4>
    <canvas id="doChart" width="480" height="240"></canvas>
</div>

<script>
var map = null;
var csvData = [];
var markers = {};
var infoWindows = {};
var phChart = null, doChart = null;
var portsCoords = {};

function InitAll() {
    // ä½¿ç”¨ç•¶å‰ç¶²å€è·¯å¾‘è®€å– CSVï¼Œå¢åŠ  cache busting
    var csvUrl = './water_quality.csv?t=' + new Date().getTime();
    
    fetch(csvUrl)
        .then(res => {
            if(!res.ok) throw new Error("CSV Not Found");
            return res.text();
        })
        .then(txt => {
            var parsed = Papa.parse(txt, { header: true, skipEmptyLines: true });
            csvData = parsed.data;

            portsCoords = {}; 
            csvData.forEach(row => {
                var name = (row.port || "").trim();
                if (name && row.x && row.y) {
                    portsCoords[name] = { lng: parseFloat(row.x), lat: parseFloat(row.y) };
                }
            });

            updateDropdown();
            if (!map) initMap(); else createMarkers();
        })
        .catch(err => {
            console.error("è¼‰å…¥éŒ¯èª¤:", err);
            // ç¢ºä¿å³ä½¿ CSV å¤±æ•—ä¹Ÿè¦é¡¯ç¤ºåœ°åœ–
            if (!map) initMap();
        });
}

function updateDropdown() {
    var sel = document.getElementById('portSelect');
    sel.innerHTML = '<option value="">-- è«‹é¸æ“‡æ¼æ¸¯ --</option>';
    Object.keys(portsCoords).sort().forEach(n => {
        var opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
    });
}

function initMap() {
    var div = document.getElementById('MapDiv');
    try {
        map = new TGOS.TGOnlineMap(div, TGOS.TGCoordSys.EPSG4326);
        map.setCenter(new TGOS.TGPoint(121.85, 24.75)); 
        map.setZoom(10);
        createMarkers();
    } catch(e) {
        console.error("TGOS åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key æ¬Šé™:", e);
    }
}

function createMarkers() {
    for (var k in markers) { markers[k].setMap(null); }
    markers = {};
    var img = new TGOS.TGImage("https://api.tgos.tw/TGOS_API/images/marker2.png", new TGOS.TGSize(38,33));
    
    Object.keys(portsCoords).forEach(name => {
        var pt = new TGOS.TGPoint(portsCoords[name].lng, portsCoords[name].lat);
        var mk = new TGOS.TGMarker(map, pt, name, img);
        markers[name] = mk;
        var iw = new TGOS.TGInfoWindow("<b>" + name + "</b>", pt);
        infoWindows[name] = iw;
        TGOS.TGEvent.addListener(mk, "click", () => showPortData(name));
    });
}

function onPortChange() {
    var name = document.getElementById('portSelect').value;
    if (name) showPortData(name);
}

function showPortData(name) {
    document.getElementById('currentPort').textContent = name;
    document.getElementById('portSelect').value = name;
    if (markers[name]) {
        map.setCenter(markers[name].getPosition());
        for (var k in infoWindows) infoWindows[k].close();
        infoWindows[name].open(map);
    }
    drawCharts(name);
}

function drawCharts(name) {
    var filtered = csvData.filter(r => (r.port || "").trim() === name);
    filtered.sort((a,b) => (parseInt(a.year)*100 + parseInt(a.month)) - (parseInt(b.year)*100 + parseInt(b.month)));

    var labels = filtered.map(r => r.year + "/" + r.month);
    var phData = filtered.map(r => parseFloat(r.ph));
    var doData = filtered.map(r => parseFloat(r.do));

    if (phChart) phChart.destroy();
    phChart = new Chart(document.getElementById('phChart'), {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'pH', data: phData, borderColor: 'orange', fill: false }] },
        options: { responsive: false }
    });

    if (doChart) doChart.destroy();
    doChart = new Chart(document.getElementById('doChart'), {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'DO (mg/L)', data: doData, borderColor: 'blue', fill: false }] },
        options: { responsive: false }
    });
}
</script>
</body>
</html>
