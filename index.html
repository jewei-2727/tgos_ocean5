<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>宜蘭漁港水質監測系統</title>
    <script type="text/javascript" src="https://api.tgos.tw/TGOS_API/tgos?ver=2&AppID=x+JLVSx85Lk=&APIKey=in8W74q0ogpcfW/STwicK8D5QwCdddJf05/7nb+OtDh8R99YN3T0LurV4xato3TpL/fOfylvJ9Wv/khZEsXEWxsBmg+GEj4AuokiNXCh14Rei21U5GtJpIkO++Mq3AguFK/ISDEWn4hMzqgrkxNe1Q==" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; display: flex; height: 100vh; width: 100vw; overflow: hidden; }
        #MapDiv { flex: 1; height: 100%; position: relative; }
        #controlPanel { 
            width: 400px; 
            height: 100%; 
            background: #fff; 
            padding: 20px; 
            box-sizing: border-box; 
            overflow-y: auto; 
            border-left: 1px solid #ccc;
            z-index: 10;
        }
        h3 { color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 8px; margin-top: 0; }
        .row { margin-bottom: 20px; }
        select { width: 100%; padding: 10px; font-size: 16px; }
        #chartSection { display: none; margin-top: 20px; }
        .chart-container { position: relative; height: 200px; width: 100%; margin-bottom: 20px; }
    </style>
</head>
<body onload="InitAll();">

    <div id="MapDiv"></div>
    
    <div id="controlPanel">
        <h3>漁港水質監測</h3>
        <div class="row">
            <label>選擇監測漁港：</label>
            <select id="portSelect" onchange="onPortChange()">
                <option value="">-- 請選擇漁港 --</option>
            </select>
        </div>

        <div id="chartSection">
            <b id="currentTitle" style="color:red; font-size:1.2em;"></b>
            <hr>
            <canvas id="phChart" class="chart-container"></canvas>
            <canvas id="doChart" class="chart-container"></canvas>
        </div>

        <div id="welcomeText" style="margin-top:50px; text-align:center; color:#888;">
            請選取漁港，地圖將自動跳轉至該位置。
        </div>
    </div>

<script>
var map = null;
var csvData = [];
var markers = {};
var phChartInstance = null;
var doChartInstance = null;

// 14個漁港座標 (TWD97)
var portsCoords = {
    "梗枋漁港": { x: 337898.4, y: 2755463.9 },
    "烏石港": { x: 334358.5, y: 2750928.9 },
    "大溪第一漁港": { x: 340901.8, y: 2759624.4 },
    "大溪第二漁港": { x: 340968.9, y: 2759546.8 },
    "蕃薯寮漁港": { x: 342563.8, y: 2760805.5 },
    "大里漁港": { x: 343220, y: 2761946.8 },
    "石城漁港": { x: 346200.7, y: 2763897.6 },
    "桶盤堀漁港": { x: 344719.1, y: 2763183 },
    "蘇澳港": { x: 337357.7, y: 2720456.9 },
    "南方澳第三漁港": { x: 337508.2, y: 2720049.9 },
    "南方澳第一漁港": { x: 337609.1, y: 2719860.5 },
    "南方澳第二漁港": { x: 337695.5, y: 2719360.5 },
    "粉鳥林漁港": { x: 335186, y: 2710502.8 },
    "朝陽漁港": { x: 332832.6, y: 2706456.8 }
};

function InitAll() {
    fetch('water_quality.csv?t=' + Date.now())
        .then(res => res.text())
        .then(text => {
            csvData = Papa.parse(text.trim(), { header: true, skipEmptyLines: true, dynamicTyping: true }).data;
            updateDropdown();
            initMap();
        });
}

function updateDropdown() {
    var sel = document.getElementById('portSelect');
    Object.keys(portsCoords).sort().forEach(name => {
        var opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        sel.appendChild(opt);
    });
}

function initMap() {
    var mapDiv = document.getElementById("MapDiv");
    // 初始化地圖，預設定位在烏石港
    var startPt = new TGOS.TGPoint(334358.5, 2750928.9);
    map = new TGOnlineMap(mapDiv, TGOS.TGCoordSys.EPSG3826, {
        center: startPt,
        zoom: 14
    });

    // 建立標記
    createMarkers();
}

function createMarkers() {
    var img = new TGOS.TGImage("https://api.tgos.tw/TGOS_API/images/marker2.png", new TGOS.TGSize(38, 33));
    
    Object.keys(portsCoords).forEach(name => {
        var pt = new TGOS.TGPoint(portsCoords[name].x, portsCoords[name].y);
        var mk = new TGOS.TGMarker(map, pt, name, img);
        markers[name] = mk;
        
        // 點擊標記觸發
        TGOS.TGEvent.addListener(mk, "click", function() {
            showPortData(name);
        });
    });
}

function onPortChange() {
    var name = document.getElementById('portSelect').value;
    if (name) showPortData(name);
}

function showPortData(name) {
    document.getElementById('portSelect').value = name;
    document.getElementById('chartSection').style.display = 'block';
    document.getElementById('welcomeText').style.display = 'none';
    document.getElementById('currentTitle').innerText = name;

    // 地圖跳轉核心代碼
    if (portsCoords[name]) {
        var targetPt = new TGOS.TGPoint(portsCoords[name].x, portsCoords[name].y);
        map.setCenter(targetPt);
        map.setZoom(15);
    }

    var rows = csvData.filter(r => String(r.port).trim() === name);
    rows.sort((a, b) => (a.year * 100 + a.month) - (b.year * 100 + b.month));
    if (rows.length > 0) drawCharts(rows);
}

function drawCharts(rows) {
    var labels = rows.map(r => r.year + "/" + r.month);
    if (phChartInstance) phChartInstance.destroy();
    if (doChartInstance) doChartInstance.destroy();

    phChartInstance = new Chart(document.getElementById('phChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{ label: 'pH值', data: rows.map(r => r.ph), borderColor: 'orange', fill: false }]
        },
        options: { maintainAspectRatio: false }
    });

    doChartInstance = new Chart(document.getElementById('doChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{ label: '溶氧量 (mg/L)', data: rows.map(r => r.do), borderColor: 'blue', fill: false }]
        },
        options: { maintainAspectRatio: false }
    });
}
</script>
</body>
</html>
