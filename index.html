<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>宜蘭漁港水質監測</title>
    <script type="text/javascript" src="https://api.tgos.tw/TGOS_API/tgos?ver=2&AppID=x+JLVSx85Lk=&APIKey=in8W74q0ogpcfW/STwicK8D5QwCdddJf05/7nb+OtDh8R99YN3T0LurV4xato3TpL/fOfylvJ9Wv/khZEsXEWxsBmg+GEj4AuokiNXCh14Rei21U5GtJpIkO++Mq3AguFK/ISDEWn4hMzqgrkxNe1Q==" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #MapDiv { position: absolute; top: 0; left: 0; width: calc(100% - 520px); height: 100vh; border-right: 1px solid #333; }
        #controlPanel { position: absolute; top: 0; right: 0; width: 520px; height: 100vh; background: #fff; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        .row { margin-bottom: 10px; }
        canvas { background: #fff; border: 1px solid #eee; margin-bottom: 10px; }
        #currentPort { font-weight: bold; color: #e74c3c; }
    </style>
</head>
<body onload="InitAll();">
    <div id="MapDiv"></div>
    <div id="controlPanel">
        <h3>宜蘭漁港水質監控</h3>
        <div class="row">
            <button onclick="InitAll()">更新資料</button>
            <select id="portSelect" onchange="onPortChange()">
                <option value="">-- 選擇漁港 --</option>
            </select>
        </div>
        <div class="row">目前顯示：<span id="currentPort">未選擇</span></div>
        <hr>
        <canvas id="phChart" width="480" height="250"></canvas>
        <canvas id="doChart" width="480" height="250"></canvas>
    </div>

<script>
// --- 全域變數 ---
var map = null;
var csvData = [];
var markers = {};
var infoWindows = {};
var phChart = null;
var doChart = null;

// 你原本的 EPSG3826 座標 (TWD97)
var portsCoords = {
    "梗枋漁港": { x: 337898.4, y: 2755463.9 },
    "烏石港": { x: 334358.5, y: 2750928.9 },
    "大溪第一漁港": { x: 340901.8, y: 2759624.4 },
    "大溪第二漁港": { x: 340968.9, y: 2759546.8 },
    "蕃薯寮漁港": { x: 342563.8, y: 2760805.5 },
    "大里漁港": { x: 343220.0, y: 2761946.8 },
    "石城漁港": { x: 346200.7, y: 2763897.6 },
    "桶盤堀漁港": { x: 344719.1, y: 2763183.0 },
    "蘇澳港": { x: 337357.7, y: 2720456.9 },
    "南方澳第三漁港": { x: 337508.2, y: 2720049.9 },
    "南方澳第一漁港": { x: 337609.1, y: 2719860.5 },
    "南方澳第二漁港": { x: 337695.5, y: 2719339.7 },
    "粉鳥林漁港": { x: 335186.0, y: 2710502.8 },
    "朝陽漁港": { x: 332832.6, y: 2706456.8 }
};

function InitAll() {
    console.log("系統初始化...");
    var csvUrl = 'water_quality.csv?t=' + Date.now();
    fetch(csvUrl)
        .then(function(res) { return res.text(); })
        .then(function(txt) {
            var parsed = Papa.parse(txt, { header: true, skipEmptyLines: true });
            csvData = parsed.data;
            updateDropdown();
            if (!map) {
                initMap();
            } else {
                createMarkers();
            }
        })
        .catch(function(err) {
            console.error("CSV載入失敗:", err);
            if (!map) initMap(); 
        });
}

function updateDropdown() {
    var sel = document.getElementById('portSelect');
    sel.innerHTML = '<option value="">-- 選擇漁港 --</option>';
    var names = Object.keys(portsCoords).sort();
    names.forEach(function(n) {
        var opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
    });
}

function initMap() {
    var div = document.getElementById('MapDiv');
    try {
        // 修正 1: 僅初始化物件，不在此處立即 setCenter
        map = new TGOS.TGOnlineMap(div, TGOS.TGCoordSys.EPSG3826);
        
        // 修正 2: 給予 800 毫秒延遲，確保 NLSCMAP 載入完成
        setTimeout(function() {
            try {
                map.setCenter(new TGOS.TGPoint(336500, 2735000));
                map.setZoom(10);
                createMarkers();
            } catch (e) {
                console.warn("地圖內部微調中...");
            }
        }, 800);
    } catch (err) {
        console.error("地圖初始化失敗:", err);
    }
}

function createMarkers() {
    // 檢查 map 是否存在
    if (!map) return;

    for (var k in markers) { if(markers[k]) markers[k].setMap(null); }
    markers = {};

    var img = new TGOS.TGImage("https://api.tgos.tw/TGOS_API/images/marker2.png", new TGOS.TGSize(38,33));
    
    Object.keys(portsCoords).forEach(function(name) {
        // 修正 3: 安全讀取座標，避免 reading 'x' 錯誤
        var coord = portsCoords[name];
        if (!coord) return;

        var pt = new TGOS.TGPoint(coord.x, coord.y);
        var mk = new TGOS.TGMarker(map, pt, name, img);
        markers[name] = mk;
        
        var iw = new TGOS.TGInfoWindow("<b>" + name + "</b>", pt);
        infoWindows[name] = iw;

        TGOS.TGEvent.addListener(mk, "click", function() {
            showPortData(name);
        });
    });
}

function onPortChange() {
    var name = document.getElementById('portSelect').value;
    if (name) showPortData(name);
}

function showPortData(name) {
    document.getElementById('currentPort').textContent = name;
    document.getElementById('portSelect').value = name;
    
    // 確保標記與地圖已就緒
    if (markers[name] && map) {
        map.setCenter(markers[name].getPosition());
        for (var k in infoWindows) { if(infoWindows[k]) infoWindows[k].close(); }
        infoWindows[name].open(map);
    }
    
    drawCharts(name);
}

function drawCharts(name) {
    var filtered = csvData.filter(function(r) { return r.port === name; });
    filtered.sort(function(a,b) { 
        return (parseInt(a.year)*100 + parseInt(a.month)) - (parseInt(b.year)*100 + parseInt(b.month)); 
    });

    var labels = filtered.map(function(r) { return r.year + "/" + r.month; });
    var phData = filtered.map(function(r) { return parseFloat(r.ph); });
    var doData = filtered.map(function(r) { return parseFloat(r.do); });

    if (phChart) phChart.destroy();
    phChart = new Chart(document.getElementById('phChart'), {
        type: 'line',
        data: { labels: labels, datasets: [{ label: name + ' pH', data: phData, borderColor: 'orange', fill: false }] },
        options: { responsive: false }
    });

    if (doChart) doChart.destroy();
    doChart = new Chart(document.getElementById('doChart'), {
        type: 'line',
        data: { labels: labels, datasets: [{ label: name + ' DO', data: doData, borderColor: 'blue', fill: false }] },
        options: { responsive: false }
    });
}
</script>
</body>
</html>
