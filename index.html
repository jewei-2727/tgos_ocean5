æˆ‘å®Œå…¨æ˜ç™½äº†ã€‚æˆ‘å€‘è¦ä¿ç•™ TGOS åœ°åœ–æœ€åŸå§‹çš„è¨­å®šï¼ˆæ»¿ç‰ˆæˆ–é è¨­å¯¬åº¦ï¼‰ï¼Œä¸¦ç¢ºä¿æ°´è³ªè¶¨å‹¢åœ–ï¼ˆChart.jsï¼‰æ˜¯é¡¯ç¤ºåœ¨å´é‚Šé¸å–®çš„ä¸‹æ–¹ã€‚

é€™æ¨£åœ°åœ–å°±ä¸æœƒå› ç‚ºå®¹å™¨å°ºå¯¸æ”¹è®Šè€Œç”¢ç”Ÿã€Œåœ–ç£šä¸æä¾›ã€çš„å•é¡Œï¼Œå› ç‚ºæˆ‘å€‘è®“åœ°åœ–å›åˆ°æœ€ç©©å®šçš„é…ç½®ã€‚

ä¿®æ­£å¾Œçš„ç¨‹å¼ç¢¼ï¼šä¿ç•™ TGOS åŸå§‹è¨­å®š + å´é‚Šè¶¨å‹¢åœ–
HTML

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>å®œè˜­æ¼æ¸¯æ°´è³ªç›£æ¸¬ç³»çµ±</title>
    <script type="text/javascript" src="https://api.tgos.tw/TGOS_API/tgos?ver=2&AppID=x+JLVSx85Lk=&APIKey=in8W74q0ogpcfW/STwicK8D5QwCdddJf05/7nb+OtDh8R99YN3T0LurV4xato3TpL/fOfylvJ9Wv/khZEsXEWxsBmg+GEj4AuokiNXCh14Rei21U5GtJpIkO++Mq3AguFK/ISDEWn4hMzqgrkxNe1Q==" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        /* ä½ˆå±€è¨­å®šï¼šåœ°åœ–åœ¨å·¦ï¼Œé¢æ¿åœ¨å³ */
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* æ¢å¾© TGOS åœ°åœ–æ¨™æº–é¡¯ç¤ºæ–¹å¼ */
        #MapDiv { flex: 1; height: 100%; border-right: 1px solid #ccc; }

        /* å³å´æ§åˆ¶é¢æ¿ï¼šå¯¬åº¦å›ºå®šï¼Œå…§å®¹å¯æ²å‹• */
        #controlPanel { 
            width: 400px; 
            height: 100vh; 
            background: #ffffff; 
            padding: 20px; 
            box-sizing: border-box; 
            overflow-y: auto; 
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
        }
        
        h3 { color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 8px; margin-top: 0; }
        .row { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        select { width: 100%; padding: 10px; font-size: 16px; border-radius: 4px; border: 1px solid #ccc; }
        
        /* è¶¨å‹¢åœ–å€å¡Š */
        #chartSection { display: none; margin-top: 20px; }
        .chart-container { position: relative; height: 250px; width: 100%; margin-bottom: 30px; }
        #currentTitle { font-size: 1.2em; color: #d93025; font-weight: bold; margin-bottom: 15px; display: block; }
    </style>
</head>
<body onload="InitAll();">

    <div id="MapDiv"></div>
    
    <div id="controlPanel">
        <h3>æ¼æ¸¯æ°´è³ªç›£æ¸¬</h3>
        
        <div class="row">
            <label>è«‹é¸æ“‡æ¼æ¸¯ï¼š</label>
            <select id="portSelect" onchange="onPortChange()">
                <option value="">-- è«‹é¸æ“‡æ¼æ¸¯ --</option>
            </select>
        </div>

        <div id="chartSection">
            <span id="currentTitle"></span>
            
            <label>pHå€¼ è¶¨å‹¢åœ–</label>
            <div class="chart-container">
                <canvas id="phChart"></canvas>
            </div>
            
            <label>æº¶æ°§é‡ (DO) è¶¨å‹¢åœ– (mg/L)</label>
            <div class="chart-container">
                <canvas id="doChart"></canvas>
            </div>
        </div>

        <div id="welcomeText" style="color: #666; text-align: center; margin-top: 50px;">
            è«‹é¸å–æ¼æ¸¯åœ°é»ä»¥æŸ¥çœ‹æ¡æ¨£æ•¸æ“šã€‚<br><br>
            é è¨­é¡¯ç¤ºï¼š<b>çƒçŸ³æ¼æ¸¯</b>
        </div>
    </div>

<script>
var map = null;
var csvData = [];
var markers = {};
var phChartInstance = null;
var doChartInstance = null;

// å®œè˜­æ¼æ¸¯åº§æ¨™ (EPSG:3826)
var portsCoords = {
    "æ¢—æ‹æ¼æ¸¯": { x: 337898.4, y: 2755463.9 },
    "çƒçŸ³æ¸¯": { x: 334358.5, y: 2750928.9 },
    "å¤§æºªç¬¬ä¸€æ¼æ¸¯": { x: 340901.8, y: 2759624.4 },
    "å¤§æºªç¬¬äºŒæ¼æ¸¯": { x: 340968.9, y: 2759546.8 },
    "è•ƒè–¯å¯®æ¼æ¸¯": { x: 342563.8, y: 2760805.5 },
    "å¤§é‡Œæ¼æ¸¯": { x: 343220, y: 2761946.8 },
    "çŸ³åŸæ¼æ¸¯": { x: 346200.7, y: 2763897.6 },
    "æ¡¶ç›¤å €æ¼æ¸¯": { x: 344719.1, y: 2763183 },
    "è˜‡æ¾³æ¸¯": { x: 337357.7, y: 2720456.9 },
    "å—æ–¹æ¾³ç¬¬ä¸‰æ¼æ¸¯": { x: 337508.2, y: 2720049.9 },
    "å—æ–¹æ¾³ç¬¬ä¸€æ¼æ¸¯": { x: 337609.1, y: 2719860.5 },
    "å—æ–¹æ¾³ç¬¬äºŒæ¼æ¸¯": { x: 337695.5, y: 2719360.5 },
    "ç²‰é³¥æ—æ¼æ¸¯": { x: 335186, y: 2710502.8 },
    "æœé™½æ¼æ¸¯": { x: 332832.6, y: 2706456.8 }
};

function InitAll() {
    // è®€å– CSV æª”æ¡ˆ
    fetch('water_quality.csv?t=' + Date.now())
        .then(res => res.text())
        .then(text => {
            var parsed = Papa.parse(text.trim(), { header: true, skipEmptyLines: true, dynamicTyping: true });
            csvData = parsed.data;
            updateDropdown();
            initMap();
        });
}

function updateDropdown() {
    var sel = document.getElementById('portSelect');
    Object.keys(portsCoords).sort().forEach(name => {
        var opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        sel.appendChild(opt);
    });
}

function initMap() {
    // åˆå§‹åŒ–åœ°åœ–
    map = new TGOS.TGOnlineMap(document.getElementById("MapDiv"), TGOS.TGCoordSys.EPSG3826);
    
    // ç•¶åœ°åœ–åº•åœ–åŠ è¼‰å®Œæˆå¾Œ
    TGOS.TGEvent.addListener(map, 'tilesloaded', function() {
        // è¨­å®šåˆå§‹ä½ç½®ç‚ºçƒçŸ³æ¸¯ï¼Œé¿é–‹åœ–ç£šä¸æä¾›å•é¡Œ
        var startPt = new TGOS.TGPoint(334358.5, 2750928.9);
        map.setCenter(startPt);
        map.setZoom(14);
        
        createMarkers();
    });
}

function createMarkers() {
    var img = new TGOS.TGImage("https://api.tgos.tw/TGOS_API/images/marker2.png", new TGOS.TGSize(38, 33));
    Object.keys(portsCoords).forEach(name => {
        var pt = new TGOS.TGPoint(portsCoords[name].x, portsCoords[name].y);
        var mk = new TGOS.TGMarker(map, pt, name, img);
        markers[name] = mk;
        // é»æ“Šåœ°åœ–åœ–ç¤ºä¹Ÿæœƒè§¸ç™¼å³å´æ•¸æ“šæ›´æ–°
        TGOS.TGEvent.addListener(mk, "click", () => showPortData(name));
    });
}

function onPortChange() {
    var name = document.getElementById('portSelect').value;
    if (name) showPortData(name);
}

function showPortData(name) {
    // æ›´æ–°ä»‹é¢ç‹€æ…‹
    document.getElementById('portSelect').value = name;
    document.getElementById('chartSection').style.display = 'block';
    document.getElementById('welcomeText').style.display = 'none';
    document.getElementById('currentTitle').innerText = "ğŸ“ " + name;

    // åœ°åœ–å°ç„¦
    if (markers[name]) {
        map.setCenter(markers[name].getPosition());
        map.setZoom(15);
    }

    // éæ¿¾è³‡æ–™ä¸¦ç¹ªåœ–
    var rows = csvData.filter(r => String(r.port).trim() === name);
    rows.sort((a, b) => (a.year * 100 + a.month) - (b.year * 100 + b.month));

    if (rows.length > 0) {
        drawCharts(rows);
    }
}

function drawCharts(rows) {
    var labels = rows.map(r => r.year + "/" + r.month);
    
    // éŠ·æ¯€èˆŠåœ–è¡¨é˜²æ­¢é‡ç–Š
    if (phChartInstance) phChartInstance.destroy();
    if (doChartInstance) doChartInstance.destroy();

    // å»ºç«‹ pH åœ–è¡¨
    phChartInstance = new Chart(document.getElementById('phChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'pHå€¼',
                data: rows.map(r => r.ph),
                borderColor: '#f39c12',
                tension: 0.3,
                fill: false
            }]
        },
        options: { maintainAspectRatio: false }
    });

    // å»ºç«‹ DO åœ–è¡¨
    doChartInstance = new Chart(document.getElementById('doChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'æº¶æ°§é‡ (mg/L)',
                data: rows.map(r => r.do),
                borderColor: '#3498db',
                tension: 0.3,
                fill: false
            }]
        },
        options: { maintainAspectRatio: false }
    });
}
</script>
</body>
</html>
</html>

