<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; style-src * 'unsafe-inline';">
    
    <title>å®œè˜­æ¼æ¸¯æ°´è³ªç›£æ§ç³»çµ± - GitHub ç‰ˆ</title>

    <script type="text/javascript" src="https://api.tgos.tw/TGOS_API/tgos?ver=2&AppID=x+JLVSx85Lk=&APIKey=in8W74q0ogpcfW/STwicK8D5QwCdddJf05/7nb+OtDh8R99YN3T0LurV4xato3TpL/fOfylvJ9Wv/khZEsXEWxsBmg+GEj4AuokiNXCh14Rei21U5GtJpIkO++Mq3AguFK/ISDEWn4hMzqgrkxNe1Q==" charset="utf-8"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; background: #f4f7f6; }
        #MapDiv { position: absolute; top: 0; left: 0; width: calc(100% - 520px); height: 100vh; border-right: 1px solid #333; }
        #controlPanel { position: absolute; top: 0; right: 0; width: 520px; height: 100vh; background: #fff; padding: 20px; box-sizing: border-box; overflow-y: auto; z-index: 10; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
        .row { margin-bottom: 15px; }
        h3 { color: #2c3e50; border-left: 5px solid #3498db; padding-left: 10px; margin-top: 0; }
        select { padding: 8px; width: 220px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 8px 15px; cursor: pointer; background: #3498db; color: white; border: none; border-radius: 4px; font-weight: bold; }
        button:hover { background: #2980b9; }
        canvas { background: #fff; border: 1px solid #eee; margin-top: 10px; border-radius: 8px; }
        .info-box { background: #ecf0f1; padding: 12px; border-radius: 6px; margin: 10px 0; border-left: 5px solid #bdc3c7; }
        #currentPort { font-weight: bold; color: #e74c3c; font-size: 1.1em; }
        hr { border: 0; border-top: 1px solid #eee; margin: 20px 0; }
    </style>
</head>
<body onload="InitAll();">

<div id="MapDiv"></div>

<div id="controlPanel">
    <h3>å®œè˜­æ¼æ¸¯æ°´è³ªç›£æ§ç³»çµ±</h3>
    
    <div class="row">
        <button onclick="InitAll()">ğŸ”„ æ›´æ–°è³‡æ–™èˆ‡åœ°åœ–</button>
    </div>

    <div class="row">
        <label for="portSelect"><b>é¸æ“‡æ¼æ¸¯ï¼š</b></label>
        <select id="portSelect" onchange="onPortChange()">
            <option value="">-- è¼‰å…¥ä¸­ --</option>
        </select>
    </div>

    <div class="info-box">
        ç›®å‰æª¢è¦–ä½ç½®ï¼š<span id="currentPort">æœªé¸æ“‡</span>
    </div>

    <hr>

    <canvas id="phChart" width="480" height="250"></canvas>
    <canvas id="doChart" width="480" height="250"></canvas>
</div>

<script>
// --- å…¨åŸŸè®Šæ•¸å®šç¾© ---
var map = null;
var csvData = [];
var markers = {};
var infoWindows = {};
var phChart = null, doChart = null;

// å›ºå®šç²¾ç¢ºç¶“ç·¯åº¦åº§æ¨™ (WGS84)
var portsCoords = {
    "æ¢—æ‹æ¼æ¸¯": { lng: 121.868748, lat: 24.903815 },
    "çƒçŸ³æ¸¯": { lng: 121.833722, lat: 24.862932 },
    "å¤§æºªç¬¬ä¸€æ¼æ¸¯": { lng: 121.898562, lat: 24.941374 },
    "å¤§æºªç¬¬äºŒæ¼æ¸¯": { lng: 121.899226, lat: 24.940673 },
    "è•ƒè–¯å¯®æ¼æ¸¯": { lng: 121.914997, lat: 24.952099 },
    "å¤§é‡Œæ¼æ¸¯": { lng: 121.921493, lat: 24.962393 },
    "çŸ³åŸæ¼æ¸¯": { lng: 121.951012, lat: 24.979958 },
    "æ¡¶ç›¤å €æ¼æ¸¯": { lng: 121.936331, lat: 24.973508 },
    "è˜‡æ¾³æ¸¯": { lng: 121.864898, lat: 24.587543 },
    "å—æ–¹æ¾³ç¬¬ä¸‰æ¼æ¸¯": { lng: 121.866381, lat: 24.583869 },
    "å—æ–¹æ¾³ç¬¬ä¸€æ¼æ¸¯": { lng: 121.867377, lat: 24.582158 },
    "å—æ–¹æ¾³ç¬¬äºŒæ¼æ¸¯": { lng: 121.868235, lat: 24.577644 },
    "ç²‰é³¥æ—æ¼æ¸¯": { lng: 121.843455, lat: 24.497639 },
    "æœé™½æ¼æ¸¯": { lng: 121.820200, lat: 24.461127 }
};

/**
 * åˆå§‹åŒ–å‡½æ•¸ï¼šè®€å– CSV ä¸¦å»ºç«‹åœ°åœ–
 */
function InitAll() {
    console.log("ç³»çµ±åˆå§‹åŒ–ä¸­...");
    // ä½¿ç”¨ç›¸å°è·¯å¾‘åŠ ä¸Šæ™‚é–“æˆ³è¨˜ï¼Œé˜²æ­¢ GitHub å¿«å–èˆŠè³‡æ–™
    var csvUrl = './water_quality.csv?t=' + new Date().getTime();
    
    fetch(csvUrl)
        .then(function(res) {
            if (!res.ok) throw new Error("æ‰¾ä¸åˆ° CSV æª”æ¡ˆ");
            return res.text();
        })
        .then(function(txt) {
            console.log("CSV è®€å–æˆåŠŸ");
            var parsed = Papa.parse(txt, { header: true, skipEmptyLines: true });
            csvData = parsed.data;
            
            updateDropdown();
            
            if (!map) {
                initMap();
            } else {
                createMarkers();
            }
        })
        .catch(function(err) {
            console.error("è¼‰å…¥å¤±æ•—:", err);
            // å³ä½¿ CSV è®€ä¸åˆ°ï¼Œä¹Ÿå¿…é ˆæŠŠåœ°åœ–å•Ÿå‹•
            if (!map) initMap();
        });
}

/**
 * å»ºç«‹ä¸‹æ‹‰é¸å–®å…§å®¹
 */
function updateDropdown() {
    var sel = document.getElementById('portSelect');
    sel.innerHTML = '<option value="">-- è«‹é¸æ“‡æ¼æ¸¯ --</option>';
    
    var names = Object.keys(portsCoords).sort();
    names.forEach(function(n) {
        var opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
    });
}

/**
 * å•Ÿå‹• TGOS åœ°åœ– (WGS84 ç¶“ç·¯åº¦æ¨¡å¼)
 */
function initMap() {
    var div = document.getElementById('MapDiv');
    try {
        // ä½¿ç”¨ EPSG:4326 æ¨™æº–ç¶“ç·¯åº¦ç³»çµ±
        map = new TGOS.TGOnlineMap(div, TGOS.TGCoordSys.EPSG4326);
        map.setCenter(new TGOS.TGPoint(121.85, 24.75)); 
        map.setZoom(10);
        createMarkers();
    } catch (e) {
        console.error("åœ°åœ–åˆå§‹åŒ–å ±éŒ¯ (å¯èƒ½æ˜¯ API Key æ¬Šé™å•é¡Œ):", e);
    }
}

/**
 * åœ¨åœ°åœ–ä¸Šæ”¾ç½®æ¼æ¸¯æ¨™è¨˜
 */
function createMarkers() {
    // æ¸…é™¤èˆŠæ¨™è¨˜é˜²æ­¢é‡è¤‡å‡ºç¾
    for (var k in markers) { if (markers[k]) markers[k].setMap(null); }
    markers = {};
    infoWindows = {};

    var img = new TGOS.TGImage("https://api.tgos.tw/TGOS_API/images/marker2.png", new TGOS.TGSize(38, 33));
    
    Object.keys(portsCoords).forEach(function(name) {
        var coord = portsCoords[name];
        var pt = new TGOS.TGPoint(coord.lng, coord.lat);
        var mk = new TGOS.TGMarker(map, pt, name, img);
        markers[name] = mk;
        
        var iw = new TGOS.TGInfoWindow("<b>" + name + "</b>", pt);
        infoWindows[name] = iw;

        TGOS.TGEvent.addListener(mk, "click", function() {
            showPortData(name);
        });
    });
}

/**
 * ä¸‹æ‹‰é¸å–®é€£å‹•
 */
function onPortChange() {
    var name = document.getElementById('portSelect').value;
    if (name) showPortData(name);
}

/**
 * é¡¯ç¤ºé¸ä¸­æ¸¯å£çš„è³‡æ–™
 */
function showPortData(name) {
    document.getElementById('currentPort').textContent = name;
    document.getElementById('portSelect').value = name;
    
    if (markers[name]) {
        map.setCenter(markers[name].getPosition());
        // é—œé–‰å…¶ä»–è¦–çª—
        for (var k in infoWindows) { infoWindows[k].close(); }
        infoWindows[name].open(map);
    }
    
    drawCharts(name);
}

/**
 * ä½¿ç”¨ Chart.js ç¹ªè£½è¶¨å‹¢åœ–
 */
function drawCharts(name) {
    // éæ¿¾å‡ºè©²æ¸¯å£çš„è³‡æ–™
    var filtered = csvData.filter(function(r) {
        return (r.port || "").toString().trim() === name;
    });

    // ä¾æ™‚é–“æ’åº
    filtered.sort(function(a, b) {
        return (parseInt(a.year) * 100 + parseInt(a.month)) - (parseInt(b.year) * 100 + parseInt(b.month));
    });

    var labels = filtered.map(function(r) { return r.year + "/" + r.month; });
    var phVals = filtered.map(function(r) { return parseFloat(r.ph); });
    var doVals = filtered.map(function(r) { return parseFloat(r.do); });

    // pH è¶¨å‹¢åœ–
    if (phChart) phChart.destroy();
    phChart = new Chart(document.getElementById('phChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: name + ' pH å€¼',
                data: phVals,
                borderColor: '#f39c12',
                backgroundColor: 'rgba(243, 156, 18, 0.1)',
                fill: true,
                tension: 0.3
            }]
        },
        options: { responsive: false }
    });

    // DO è¶¨å‹¢åœ–
    if (doChart) doChart.destroy();
    doChart = new Chart(document.getElementById('doChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: name + ' æº¶æ°§é‡ (mg/L)',
                data: doVals,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                fill: true,
                tension: 0.3
            }]
        },
        options: { responsive: false }
    });
}
</script>
</body>
</html>
