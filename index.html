<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>宜蘭漁港水質監測 - 經緯度精確版</title>
    <script type="text/javascript" src="https://api.tgos.tw/TGOS_API/tgos?ver=2&AppID=x+JLVSx85Lk=&APIKey=in8W74q0ogpcfW/STwicK8D5QwCdddJf05/7nb+OtDh8R99YN3T0LurV4xato3TpL/fOfylvJ9Wv/khZEsXEWxsBmg+GEj4AuokiNXCh14Rei21U5GtJpIkO++Mq3AguFK/ISDEWn4hMzqgrkxNe1Q==" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; }
        #MapDiv { position: absolute; top: 0; left: 0; width: calc(100% - 520px); height: 100vh; border-right: 1px solid #333; }
        #controlPanel { position: absolute; top: 0; right: 0; width: 520px; height: 100vh; background: #fff; padding: 15px; box-sizing: border-box; overflow-y: auto; }
        .row { margin-bottom: 10px; }
        canvas { background: #fff; border: 1px solid #eee; margin-bottom: 10px; }
        #currentPort { font-weight: bold; color: #e74c3c; }
    </style>
</head>
<body onload="InitAll();">

<div id="MapDiv"></div>
<div id="controlPanel">
    <h3>宜蘭漁港水質監控系統</h3>
    <div class="row">
        <button onclick="InitAll()">更新資料</button>
        <select id="portSelect" onchange="onPortChange()">
            <option value="">-- 選擇漁港 --</option>
        </select>
    </div>
    <div class="row">目前顯示：<span id="currentPort">未選擇</span></div>
    <hr>
    <canvas id="phChart" width="480" height="250"></canvas>
    <canvas id="doChart" width="480" height="250"></canvas>
</div>

<script>
var map = null;
var csvData = [];
var markers = {};
var infoWindows = {};
var phChart = null, doChart = null;

// 直接使用您提供的 WGS84 經緯度 (lng = 121.x, lat = 24.x)
var portsCoords = {
    "梗枋漁港": { lng: 121.868748, lat: 24.903815 },
    "烏石港": { lng: 121.833722, lat: 24.862932 },
    "大溪第一漁港": { lng: 121.898562, lat: 24.941374 },
    "大溪第二漁港": { lng: 121.899226, lat: 24.940673 },
    "蕃薯寮漁港": { lng: 121.914997, lat: 24.952099 },
    "大里漁港": { lng: 121.921493, lat: 24.962393 },
    "石城漁港": { lng: 121.951012, lat: 24.979958 },
    "桶盤堀漁港": { lng: 121.936331, lat: 24.973508 },
    "蘇澳港": { lng: 121.864898, lat: 24.587543 },
    "南方澳第三漁港": { lng: 121.866381, lat: 24.583869 },
    "南方澳第一漁港": { lng: 121.867377, lat: 24.582158 },
    "南方澳第二漁港": { lng: 121.868235, lat: 24.577644 },
    "粉鳥林漁港": { lng: 121.843455, lat: 24.497639 },
    "朝陽漁港": { lng: 121.820200, lat: 24.461127 }
};

function InitAll() {
    var csvUrl = 'water_quality.csv?t=' + Date.now();
    fetch(csvUrl)
        .then(function(res) { return res.text(); })
        .then(function(txt) {
            var parsed = Papa.parse(txt, { header: true, skipEmptyLines: true });
            csvData = parsed.data;
            updateDropdown();
            if (!map) initMap(); else createMarkers();
        })
        .catch(function(err) {
            console.error("CSV載入失敗:", err);
            if (!map) initMap();
        });
}

function updateDropdown() {
    var sel = document.getElementById('portSelect');
    sel.innerHTML = '<option value="">-- 選擇漁港 --</option>';
    Object.keys(portsCoords).sort().forEach(function(n) {
        var opt = document.createElement('option');
        opt.value = n; opt.textContent = n; sel.appendChild(opt);
    });
}

function initMap() {
    var div = document.getElementById('MapDiv');
    // 重要修正：使用 EPSG4326 (經緯度座標系)
    map = new TGOS.TGOnlineMap(div, TGOS.TGCoordSys.EPSG4326);
    map.setCenter(new TGOS.TGPoint(121.85, 24.75)); // 宜蘭中心經緯度
    map.setZoom(10);
    createMarkers();
}

function createMarkers() {
    for (var k in markers) { markers[k].setMap(null); }
    markers = {};
    var img = new TGOS.TGImage("https://api.tgos.tw/TGOS_API/images/marker2.png", new TGOS.TGSize(38,33));
    
    Object.keys(portsCoords).forEach(function(name) {
        // 使用經緯度直接建立點位
        var pt = new TGOS.TGPoint(portsCoords[name].lng, portsCoords[name].lat);
        var mk = new TGOS.TGMarker(map, pt, name, img);
        markers[name] = mk;
        var iw = new TGOS.TGInfoWindow("<b>" + name + "</b>", pt);
        infoWindows[name] = iw;
        TGOS.TGEvent.addListener(mk, "click", function() { showPortData(name); });
    });
}

function onPortChange() {
    var name = document.getElementById('portSelect').value;
    if (name) showPortData(name);
}

function showPortData(name) {
    document.getElementById('currentPort').textContent = name;
    document.getElementById('portSelect').value = name;
    if (markers[name]) {
        map.setCenter(markers[name].getPosition());
        for (var k in infoWindows) { infoWindows[k].close(); }
        infoWindows[name].open(map);
    }
    drawCharts(name);
}

function drawCharts(name) {
    var filtered = csvData.filter(function(r) { return String(r.port).trim() === name; });
    filtered.sort(function(a,b) { 
        return (parseInt(a.year)*100 + parseInt(a.month)) - (parseInt(b.year)*100 + parseInt(b.month)); 
    });
    var labels = filtered.map(function(r) { return r.year + "/" + r.month; });
    var phData = filtered.map(function(r) { return parseFloat(r.ph); });
    var doData = filtered.map(function(r) { return parseFloat(r.do); });

    if (phChart) phChart.destroy();
    phChart = new Chart(document.getElementById('phChart'), {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'pH', data: phData, borderColor: 'orange', fill: false }] },
        options: { responsive: false }
    });
    if (doChart) doChart.destroy();
    doChart = new Chart(document.getElementById('doChart'), {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'DO (mg/L)', data: doData, borderColor: 'blue', fill: false }] },
        options: { responsive: false }
    });
}
</script>
</body>
</html>
