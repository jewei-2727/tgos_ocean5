<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>å®œè˜­æ¼æ¸¯æ°´è³ªå‹•æ…‹ç›£æ¸¬ç³»çµ± (CSVè‡ªå‹•è®€å–ç‰ˆ)</title>
    <script type="text/javascript" src="https://api.tgos.tw/TGOS_API/tgos?ver=2&AppID=x+JLVSx85Lk=&APIKey=in8W74q0ogpcfW/STwicK8D5QwCdddJf05/7nb+OtDh8R99YN3T0LurV4xato3TpL/fOfylvJ9Wv/khZEsXEWxsBmg+GEj4AuokiNXCh14Rei21U5GtJpIkO++Mq3AguFK/ISDEWn4hMzqgrkxNe1Q==" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; background: #f8f9fa; }
        #MapDiv { position: absolute; top: 0; left: 0; width: calc(100% - 520px); height: 100vh; border-right: 2px solid #333; }
        #controlPanel { position: absolute; top: 0; right: 0; width: 520px; height: 100vh; background: #fff; padding: 20px; box-sizing: border-box; overflow-y: auto; box-shadow: -2px 0 5px rgba(0,0,0,0.1); }
        .row { margin-bottom: 15px; }
        h2 { color: #2c3e50; border-left: 5px solid #3498db; padding-left: 10px; }
        select { padding: 8px; width: 220px; border-radius: 4px; border: 1px solid #ccc; }
        button { padding: 8px 15px; cursor: pointer; background: #3498db; color: white; border: none; border-radius: 4px; }
        button:hover { background: #2980b9; }
        canvas { background: #fff; border: 1px solid #eee; margin-top: 10px; border-radius: 8px; }
        .status-box { background: #ecf0f1; padding: 10px; border-radius: 5px; margin-top: 10px; }
        #currentPort { font-weight: bold; color: #e74c3c; font-size: 1.2em; }
    </style>
</head>
<body onload="InitAll();">

<div id="MapDiv"></div>

<div id="controlPanel">
    <h2>å®œè˜­æ¼æ¸¯æ°´è³ªç›£æ¸¬</h2>
    
    <div class="row">
        <button onclick="InitAll()">ğŸ”„ é‡æ–°è¼‰å…¥ CSV è³‡æ–™</button>
    </div>

    <div class="row">
        <label for="portSelect"><b>é¸æ“‡æ¼æ¸¯ï¼š</b></label>
        <select id="portSelect" onchange="onPortChange()">
            <option value="">-- è«‹é¸æ“‡æ¼æ¸¯ --</option>
        </select>
    </div>

    <div class="status-box">
        ç›®å‰æª¢è¦–ï¼š<span id="currentPort">æœªé¸å–</span>
    </div>

    <hr>

    <h4>pH å€¼è¶¨å‹¢</h4>
    <canvas id="phChart" width="480" height="240"></canvas>

    <h4>æº¶æ°§é‡ (DO) è¶¨å‹¢ (mg/L)</h4>
    <canvas id="doChart" width="480" height="240"></canvas>
    
    <p style="font-size: 12px; color: gray; margin-top: 20px;">
        æç¤ºï¼šåœ°åœ–é»ä½æ˜¯ç”± CSV ä¸­çš„ x (ç¶“åº¦) èˆ‡ y (ç·¯åº¦) è‡ªå‹•ç”¢ç”Ÿã€‚
    </p>
</div>

<script>
// --- å…¨åŸŸè®Šæ•¸ ---
var map = null;
var csvData = [];
var markers = {};
var infoWindows = {};
var phChart = null, doChart = null;
var portsCoords = {}; // åº§æ¨™å°‡å¾ CSV å‹•æ…‹æå–

/**
 * 1. ç³»çµ±å…¥å£ï¼šè®€å– CSV
 */
function InitAll() {
    console.log("é–‹å§‹è¼‰å…¥è³‡æ–™...");
    var csvUrl = 'water_quality.csv?t=' + Date.now();
    
    fetch(csvUrl)
        .then(function(res) { 
            if(!res.ok) throw new Error("æ‰¾ä¸åˆ° CSV æª”æ¡ˆ");
            return res.text(); 
        })
        .then(function(txt) {
            var parsed = Papa.parse(txt, { header: true, skipEmptyLines: true });
            csvData = parsed.data;

            // å¾ CSV ä¸­æƒæåº§æ¨™è³‡è¨Š (x=ç¶“åº¦, y=ç·¯åº¦)
            portsCoords = {}; 
            csvData.forEach(function(row) {
                var name = (row.port || "").trim();
                if (name && row.x && row.y) {
                    // ä»¥æœ€å¾Œè®€å–åˆ°çš„åº§æ¨™ç‚ºæº–
                    portsCoords[name] = { 
                        lng: parseFloat(row.x), 
                        lat: parseFloat(row.y) 
                    };
                }
            });

            updateDropdown();
            
            if (!map) {
                initMap();
            } else {
                createMarkers();
            }
        })
        .catch(function(err) {
            console.error("åˆå§‹åŒ–å¤±æ•—:", err);
            alert("è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª CSV æª”æ¡ˆæ˜¯å¦å­˜åœ¨ä¸”æ ¼å¼æ­£ç¢ºã€‚");
        });
}

/**
 * 2. æ›´æ–°ä¸‹æ‹‰é¸å–®
 */
function updateDropdown() {
    var sel = document.getElementById('portSelect');
    var currentVal = sel.value;
    sel.innerHTML = '<option value="">-- è«‹é¸æ“‡æ¼æ¸¯ --</option>';
    
    var sortedNames = Object.keys(portsCoords).sort();
    sortedNames.forEach(function(n) {
        var opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        sel.appendChild(opt);
    });
    if(currentVal) sel.value = currentVal;
}

/**
 * 3. åˆå§‹åŒ–åœ°åœ– (WGS84 æ¨¡å¼)
 */
function initMap() {
    var div = document.getElementById('MapDiv');
    // ä½¿ç”¨ EPSG:4326 (ç¶“ç·¯åº¦) ç³»çµ±
    map = new TGOS.TGOnlineMap(div, TGOS.TGCoordSys.EPSG4326);
    map.setCenter(new TGOS.TGPoint(121.85, 24.75)); 
    map.setZoom(10);
    createMarkers();
}

/**
 * 4. æ ¹æ“š CSV åº§æ¨™å»ºç«‹åœ°åœ–æ¨™è¨˜
 */
function createMarkers() {
    // æ¸…é™¤èˆŠæ¨™è¨˜
    for (var k in markers) { markers[k].setMap(null); }
    markers = {};
    infoWindows = {};

    var img = new TGOS.TGImage("https://api.tgos.tw/TGOS_API/images/marker2.png", new TGOS.TGSize(38,33));
    
    Object.keys(portsCoords).forEach(function(name) {
        var pt = new TGOS.TGPoint(portsCoords[name].lng, portsCoords[name].lat);
        var mk = new TGOS.TGMarker(map, pt, name, img);
        markers[name] = mk;
        
        var iw = new TGOS.TGInfoWindow("<b>" + name + "</b><br>é»æ“Šçœ‹æ°´è³ªåœ–è¡¨", pt);
        infoWindows[name] = iw;

        TGOS.TGEvent.addListener(mk, "click", function() {
            showPortData(name);
        });
    });
}

/**
 * 5. åˆ‡æ›æ¸¯å£é€£å‹•
 */
function onPortChange() {
    var name = document.getElementById('portSelect').value;
    if (name) showPortData(name);
}

function showPortData(name) {
    document.getElementById('currentPort').textContent = name;
    document.getElementById('portSelect').value = name;
    
    if (markers[name]) {
        map.setCenter(markers[name].getPosition());
        for (var k in infoWindows) { infoWindows[k].close(); }
        infoWindows[name].open(map);
    }
    
    drawCharts(name);
}

/**
 * 6. ç¹ªè£½åœ–è¡¨
 */
function drawCharts(name) {
    var filtered = csvData.filter(function(r) { return (r.port || "").trim() === name; });
    
    // ä¾æ™‚é–“æ’åº (å¹´/æœˆ)
    filtered.sort(function(a,b) { 
        return (parseInt(a.year)*100 + parseInt(a.month)) - (parseInt(b.year)*100 + parseInt(b.month)); 
    });

    var labels = filtered.map(function(r) { return r.year + "/" + r.month; });
    var phData = filtered.map(function(r) { return parseFloat(r.ph); });
    var doData = filtered.map(function(r) { return parseFloat(r.do); });

    // pH Chart
    if (phChart) phChart.destroy();
    phChart = new Chart(document.getElementById('phChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'pH å€¼',
                data: phData,
                borderColor: '#e67e22',
                backgroundColor: 'rgba(230, 126, 34, 0.1)',
                tension: 0.2,
                fill: true
            }]
        },
        options: { responsive: false, scales: { y: { min: 6, max: 10 } } }
    });

    // DO Chart
    if (doChart) doChart.destroy();
    doChart = new Chart(document.getElementById('doChart').getContext('2d'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'æº¶æ°§é‡ (mg/L)',
                data: doData,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.2,
                fill: true
            }]
        },
        options: { responsive: false, scales: { y: { min: 0, max: 12 } } }
    });
}
</script>
</body>
</html>
