<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>宜蘭漁港動態水質監測圖</title>

    <script type="text/javascript"
        src="https://api.tgos.tw/TGOS_API/tgos?ver=2&AppID=x+JLVSx85Lk=&APIKey=in8W74q0ogpcfW/STwicK8D5QwCdddJf05/7nb+OtDh8R99YN3T0LurV4xato3TpL/fOfylvJ9Wv/khZEsXEWxsBmg+GEj4AuokiNXCh14Rei21U5GtJpIkO++Mq3AguFK/ISDEWn4hMzqgrkxNe1Q=="
        charset="utf-8"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; background: #f4f4f4; }
        #MapDiv {
            position: absolute;
            top: 10px;
            left: 10px;
            width: calc(100% - 550px);
            height: calc(100vh - 20px);
            border: 1px solid #333;
        }
        #controlPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 510px;
            height: calc(100vh - 20px);
            background: #fff;
            border: 1px solid #ccc;
            padding: 15px;
            box-sizing: border-box;
            overflow: auto;
            z-index: 999;
        }
        .row { margin-bottom: 15px; }
        select { padding: 5px; width: 200px; }
        canvas { background: #fff; margin-bottom: 20px; border: 1px solid #eee; }
        .small-note { font-size: 12px; color: #666; }
        #currentPort { font-weight: bold; color: #e74c3c; font-size: 18px; }
    </style>
</head>
<body onload="InitAll();">

<div id="MapDiv"></div>

<div id="controlPanel">
    <h2>漁港水質控制面板</h2>
    <div class="row">
        <button onclick="InitAll()">重新載入資料</button>
    </div>
    <div class="row">
        <label for="portSelect"><b>選擇漁港：</b></label>
        <select id="portSelect" onchange="onPortChange()">
            <option value="">-- 請選擇港口 --</option>
        </select>
    </div>
    <div class="row">
        <b>目前顯示：</b> <span id="currentPort">請選擇港口</span>
    </div>
    <hr>
    <h3>pH 值時序趨勢圖</h3>
    <canvas id="phChart" width="470" height="240"></canvas>
    <h3>DO 溶氧量時序圖 (mg/L)</h3>
    <canvas id="doChart" width="470" height="240"></canvas>
</div>

<script>
var map = null;
var csvData = []; 
var markers = {}; 
var infoWindows = {}; 
var phChart = null, doChart = null;

var portsCoords = {
    "梗枋漁港": { x: 337898.4, y: 2755463.9 },
    "烏石港": { x: 334358.5, y: 2750928.9 },
    "大溪第一漁港": { x: 340901.8, y: 2759624.4 },
    "大溪第二漁港": { x: 340968.9, y: 2759546.8 },
    "蕃薯寮漁港": { x: 342563.8, y: 2760805.5 },
    "大里漁港": { x: 343220.0, y: 2761946.8 },
    "石城漁港": { x: 346200.7, y: 2763897.6 },
    "桶盤堀漁港": { x: 344719.1, y: 2763183.0 },
    "蘇澳港": { x: 337357.7, y: 2720456.9 },
    "南方澳第三漁港": { x: 337508.2, y: 2720049.9 },
    "南方澳第一漁港": { x: 337609.1, y: 2719860.5 },
    "南方澳第二漁港": { x: 337695.5, y: 2719339.7 },
    "粉鳥林漁港": { x: 335186.0, y: 2710502.8 },
    "朝陽漁港": { x: 332832.6, y: 2706456.8 }
};

function InitAll() {
    var csvUrl = 'water_quality.csv?t=' + Date.now(); 
    fetch(csvUrl)
        .then(function(resp) {
            if(!resp.ok) throw new Error('CSV missing');
            return resp.text();
        })
        .then(function(txt) {
            var parsed = Papa.parse(txt, { header: true, skipEmptyLines: true });
            csvData = parsed.data.map(function(r) {
                return {
                    port: (r.port || "").toString().trim(),
                    year: (r.year || "").toString().trim(),
                    month: (r.month || "").toString().trim(),
                    ph: (r.ph || "").toString().trim(),
                    do: (r.do || "").toString().trim()
                };
            });
            buildPortDropdown();
            if (!map) {
                InitMap();
            } else {
                createMarkersFromConfig();
            }
        })
        .catch(function(err) {
            console.error(err);
            // 如果 CSV 讀不到，依然初始化地圖讓標記點出來
            if (!map) InitMap();
        });
}

function buildPortDropdown() {
    var sel = document.getElementById('portSelect');
    sel.innerHTML = '<option value="">-- 請選擇港口 --</option>';
    var csvPorts = csvData.map(function(r) { return r.port; });
    var allPorts = Array.from(new Set(csvPorts.concat(Object.keys(portsCoords)))).sort();
    
    allPorts.forEach(function(p) {
        if(!p) return;
        var opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        sel.appendChild(opt);
    });
}

function InitMap() {
    var mapDiv = document.getElementById('MapDiv');
    var yilanCenter = new TGOS.TGPoint(336500, 2735000);
    map = new TGOS.TGOnlineMap(mapDiv, TGOS.TGCoordSys.EPSG3826);
    map.setCenter(yilanCenter);
    map.setZoom(10);
    createMarkersFromConfig();
}

function createMarkersFromConfig() {
    for (var k in markers) { try { markers[k].setMap(null); } catch(e){} }
    markers = {}; infoWindows = {};
    var iconUrl = "https://api.tgos.tw/TGOS_API/images/marker2.png";
    var mSize = new TGOS.TGSize(38,33);
    var mImg = new TGOS.TGImage(iconUrl, mSize, new TGOS.TGPoint(0,0), new TGOS.TGPoint(10,33));

    Object.keys(portsCoords).forEach(function(name) {
        var c = portsCoords[name];
        var p = new TGOS.TGPoint(c.x, c.y);
        var marker = new TGOS.TGMarker(map, p, name, mImg);
        markers[name] = marker;
        var iw = new TGOS.TGInfoWindow("<b>" + name + "</b>", p);
        infoWindows[name] = iw;
        TGOS.TGEvent.addListener(marker, "click", function() {
            selectPort(name);
        });
    });
}

function onPortChange() {
    var p = document.getElementById('portSelect').value;
    if (p) selectPort(p);
}

function selectPort(name) {
    document.getElementById('currentPort').textContent = name;
    document.getElementById('portSelect').value = name;
    if (markers[name]) {
        map.setCenter(markers[name].getPosition());
        for (var k in infoWindows) infoWindows[k].close();
        infoWindows[name].open(map);
    }
    drawChartsForPort(name);
}

function drawChartsForPort(name) {
    var rows = csvData.filter(function(r) { return r.port === name; });
    rows.sort(function(a,b) { return (parseInt(a.year)*100+parseInt(a.month)) - (parseInt(b.year)*100+parseInt(b.month)); });
    
    if (rows.length === 0) {
        if(phChart) phChart.destroy();
        if(doChart) doChart.destroy();
        return;
    }

    var labels = rows.map(function(r) { return r.year + "/" + r.month; });
    var phs = rows.map(function(r) { return parseFloat(r.ph); });
    var dos = rows.map(function(r) { return parseFloat(r.do); });

    if (phChart) phChart.destroy();
    phChart = new Chart(document.getElementById('phChart').getContext('2d'), {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'pH', data: phs, borderColor: 'orange', fill: false }] },
        options: { responsive: false }
    });

    if (doChart) doChart.destroy();
    doChart = new Chart(document.getElementById('doChart').getContext('2d'), {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'DO (mg/L)', data: dos, borderColor: 'blue', fill: false }] },
        options: { responsive: false }
    });
}
</script>
</body>
</html>


</html>
