<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval'; script-src * 'unsafe-inline' 'unsafe-eval'; connect-src * 'unsafe-inline'; img-src * data: blob: 'unsafe-inline'; style-src * 'unsafe-inline';">
    
    <title>å®œè˜­æ¼æ¸¯æ°´è³ªå‹•æ…‹ç›£æ¸¬ç³»çµ±</title>

    <script type="text/javascript" src="https://api.tgos.tw/TGOS_API/tgos?ver=2&AppID=x+JLVSx85Lk=&APIKey=in8W74q0ogpcfW/STwicK8D5QwCdddJf05/7nb+OtDh8R99YN3T0LurV4xato3TpL/fOfylvJ9Wv/khZEsXEWxsBmg+GEj4AuokiNXCh14Rei21U5GtJpIkO++Mq3AguFK/ISDEWn4hMzqgrkxNe1Q==" charset="utf-8"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body { margin: 0; font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; overflow: hidden; }
        #MapDiv { position: absolute; top: 0; left: 0; width: calc(100% - 500px); height: 100vh; border-right: 2px solid #2c3e50; }
        #controlPanel { position: absolute; top: 0; right: 0; width: 500px; height: 100vh; background: #fff; padding: 20px; box-sizing: border-box; overflow-y: auto; z-index: 1000; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
        h2 { color: #2c3e50; border-left: 6px solid #3498db; padding-left: 12px; margin-top: 0; }
        .row { margin-bottom: 20px; }
        select { padding: 10px; width: 200px; border-radius: 4px; border: 1px solid #ddd; }
        button { padding: 10px 18px; cursor: pointer; background: #3498db; color: white; border: none; border-radius: 4px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #2980b9; }
        .status-display { background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 20px; }
        #currentPort { font-weight: bold; color: #e74c3c; font-size: 1.2em; }
        canvas { background: #fff; border: 1px solid #eee; margin-top: 10px; border-radius: 8px; }
    </style>
</head>
<body onload="InitAll();">

<div id="MapDiv"></div>

<div id="controlPanel">
    <h2>æ¼æ¸¯æ°´è³ªç›£æ¸¬é¢æ¿</h2>
    
    <div class="row">
        <button onclick="InitAll()">ğŸ”„ é‡æ–°æ•´ç†è³‡æ–™</button>
    </div>

    <div class="row">
        <label for="portSelect"><b>åˆ‡æ›æ¼æ¸¯ï¼š</b></label>
        <select id="portSelect" onchange="onPortChange()">
            <option value="">-- è«‹é¸æ“‡ --</option>
        </select>
    </div>

    <div class="status-display">
        ç›®å‰é¸å–ï¼š<span id="currentPort">æœªé¸æ“‡</span>
    </div>

    <hr>

    <h4>pH å€¼è®ŠåŒ–è¶¨å‹¢</h4>
    <canvas id="phChart" width="460" height="230"></canvas>

    <h4>æº¶æ°§é‡ (DO) è¶¨å‹¢ (mg/L)</h4>
    <canvas id="doChart" width="460" height="230"></canvas>
</div>

<script>
var map = null;
var csvData = [];
var markers = {};
var infoWindows = {};
var phChart = null, doChart = null;

// å®šç¾©ç²¾ç¢ºåº§æ¨™ (WGS84 ç¶“ç·¯åº¦)
var portsCoords = {
    "æ¢—æ‹æ¼æ¸¯": { lng: 121.868748, lat: 24.903815 },
    "çƒçŸ³æ¸¯": { lng: 121.833722, lat: 24.862932 },
    "å¤§æºªç¬¬ä¸€æ¼æ¸¯": { lng: 121.898562, lat: 24.941374 },
    "å¤§æºªç¬¬äºŒæ¼æ¸¯": { lng: 121.899226, lat: 24.940673 },
    "è•ƒè–¯å¯®æ¼æ¸¯": { lng: 121.914997, lat: 24.952099 },
    "å¤§é‡Œæ¼æ¸¯": { lng: 121.921493, lat: 24.962393 },
    "çŸ³åŸæ¼æ¸¯": { lng: 121.951012, lat: 24.979958 },
    "æ¡¶ç›¤å €æ¼æ¸¯": { lng: 121.936331, lat: 24.973508 },
    "è˜‡æ¾³æ¸¯": { lng: 121.864898, lat: 24.587543 },
    "å—æ–¹æ¾³ç¬¬ä¸‰æ¼æ¸¯": { lng: 121.866381, lat: 24.583869 },
    "å—æ–¹æ¾³ç¬¬ä¸€æ¼æ¸¯": { lng: 121.867377, lat: 24.582158 },
    "å—æ–¹æ¾³ç¬¬äºŒæ¼æ¸¯": { lng: 121.868235, lat: 24.577644 },
    "ç²‰é³¥æ—æ¼æ¸¯": { lng: 121.843455, lat: 24.497639 },
    "æœé™½æ¼æ¸¯": { lng: 121.820200, lat: 24.461127 }
};

/**
 * ç³»çµ±å•Ÿå‹•èˆ‡è³‡æ–™è¼‰å…¥
 */
function InitAll() {
    console.log("æ­£åœ¨å¾ GitHub ç²å–æœ€æ–°è³‡æ–™...");
    // åŠ ä¸Šæ™‚é–“æˆ³è¨˜é¿å…å¿«å–å•é¡Œ
    var csvUrl = './water_quality.csv?t=' + new Date().getTime();
    
    fetch(csvUrl)
        .then(res => {
            if(!res.ok) throw new Error("CSV æª”æ¡ˆæœªæ‰¾åˆ°");
            return res.text();
        })
        .then(txt => {
            var parsed = Papa.parse(txt, { header: true, skipEmptyLines: true });
            csvData = parsed.data;
            updateDropdown();
            
            // å¦‚æœåœ°åœ–å°šæœªå»ºç«‹ï¼Œå‰‡åˆå§‹åŒ–ï¼›å¦å‰‡é‡æ–°ç¹ªè£½æ¨™è¨˜
            if (!map) initMap(); else createMarkers();
        })
        .catch(err => {
            console.error("CSV è¼‰å…¥å‡ºéŒ¯ï¼Œæ”¹ç‚ºåƒ…åˆå§‹åŒ–åœ°åœ–:", err);
            if (!map) initMap();
        });
}

/**
 * æ›´æ–°ä¸‹æ‹‰é¸å–®
 */
function updateDropdown() {
    var sel = document.getElementById('portSelect');
    sel.innerHTML = '<option value="">-- è«‹é¸æ“‡æ¼æ¸¯ --</option>';
    Object.keys(portsCoords).sort().forEach(name => {
        var opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
    });
}

/**
 * åˆå§‹åŒ–åœ°åœ–ç‰©ä»¶
 */
function initMap() {
    var div = document.getElementById('MapDiv');
    try {
        // ä½¿ç”¨ WGS84 åº§æ¨™ç³»
        map = new TGOS.TGOnlineMap(div, TGOS.TGCoordSys.EPSG4326);
        
        // ã€é—œéµã€‘å»¶é²åŸ·è¡Œå°ç„¦èˆ‡æ¨™è¨˜ï¼Œé¿å… NLSCMAP è¼‰å…¥ç«¶çˆ­éŒ¯èª¤
        setTimeout(function() {
            try {
                map.setCenter(new TGOS.TGPoint(121.85, 24.75));
                map.setZoom(10);
                createMarkers();
            } catch (innerErr) {
                console.warn("åœ°åœ–å…§éƒ¨çµ„ä»¶å»¶é²ä¸­...");
            }
        }, 800); 

    } catch (e) {
        console.error("åœ°åœ–åˆå§‹åŒ–å¤±æ•—:", e);
    }
}

/**
 * ç¹ªè£½åœ°åœ–æ¨™è¨˜
 */
function createMarkers() {
    // æ¸…é™¤èˆŠæ¨™è¨˜
    for (var k in markers) { if(markers[k]) markers[k].setMap(null); }
    markers = {};
    infoWindows = {};

    var markerImg = new TGOS.TGImage("https://api.tgos.tw/TGOS_API/images/marker2.png", new TGOS.TGSize(38, 33));
    
    Object.keys(portsCoords).forEach(name => {
        var coord = portsCoords[name];
        var pt = new TGOS.TGPoint(coord.lng, coord.lat);
        var mk = new TGOS.TGMarker(map, pt, name, markerImg);
        markers[name] = mk;
        
        var iw = new TGOS.TGInfoWindow("<b>" + name + "</b><br>é»æ“Šå³å´é¸å–®çœ‹è©³ç´°åœ–è¡¨", pt);
        infoWindows[name] = iw;

        TGOS.TGEvent.addListener(mk, "click", function() {
            showPortData(name);
        });
    });
}

/**
 * ä¸‹æ‹‰é¸å–®é€£å‹•é‚è¼¯
 */
function onPortChange() {
    var name = document.getElementById('portSelect').value;
    if (name) showPortData(name);
}

/**
 * é¡¯ç¤ºç‰¹å®šæ¼æ¸¯çš„æ°´è³ªè³‡è¨Š
 */
function showPortData(name) {
    document.getElementById('currentPort').textContent = name;
    document.getElementById('portSelect').value = name;
    
    if (markers[name]) {
        map.setCenter(markers[name].getPosition());
        // é—œé–‰æ‰€æœ‰è¦–çª—å†æ‰“é–‹é¸ä¸­çš„
        for (var k in infoWindows) { infoWindows[k].close(); }
        infoWindows[name].open(map);
    }
    
    drawCharts(name);
}

/**
 * ç¹ªè£½è¶¨å‹¢åœ–è¡¨
 */
function drawCharts(name) {
    var filtered = csvData.filter(r => (r.port || "").toString().trim() === name);
    
    // ä¾å¹´æœˆæ’åºè³‡æ–™
    filtered.sort((a,b) => (parseInt(a.year)*100 + parseInt(a.month)) - (parseInt(b.year)*100 + parseInt(b.month)));

    var labels = filtered.map(r => r.year + "/" + r.month);
    var phData = filtered.map(r => parseFloat(r.ph));
    var doData = filtered.map(r => parseFloat(r.do));

    // pH åœ–è¡¨
    if (phChart) phChart.destroy();
    phChart = new Chart(document.getElementById('phChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'pH å€¼',
                data: phData,
                borderColor: '#e67e22',
                backgroundColor: 'rgba(230, 126, 34, 0.1)',
                tension: 0.3,
                fill: true
            }]
        }
    });

    // DO åœ–è¡¨
    if (doChart) doChart.destroy();
    doChart = new Chart(document.getElementById('doChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'æº¶æ°§é‡ (mg/L)',
                data: doData,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                tension: 0.3,
                fill: true
            }]
        }
    });
}
</script>
</body>
</html>
